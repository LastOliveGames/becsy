import{_ as s,c as a,a as t,b as p,r as o,o as e}from"./app.b3a7bd64.js";const h='{"title":"Components","description":"","frontmatter":{},"headers":[{"level":2,"title":"Field types","slug":"field-types"},{"level":2,"title":"Numeric vectors","slug":"numeric-vectors"},{"level":2,"title":"Referencing entities","slug":"referencing-entities"},{"level":2,"title":"Validating component combos","slug":"validating-component-combos"},{"level":2,"title":"Component enums","slug":"component-enums"},{"level":2,"title":"Storage strategies","slug":"storage-strategies"}],"relativePath":"guide/architecture/components.md","lastUpdated":1654670399000}',c={},l=p(`<h1 id="components" tabindex="-1">Components <a class="header-anchor" href="#components" aria-hidden="true">#</a></h1><p>A <em>component</em> is an object that can store data but should have no behavior (as that&#39;s handled by systems). You&#39;ll typically have many instances of a component type, each held in an entity. (Though sometimes you&#39;ll have <a href="./systems.html#singleton-components">singletons</a>.)</p><p>In Becsy, a component type is just a class with a default, empty constructor, and a schema that specifies the type of each field so that Becsy can allocate the right kind of storage:</p><div class="language-js"><pre><code><span class="token keyword">import</span> <span class="token punctuation">{</span>Type<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&#39;@lastolivegames/becsy&#39;</span><span class="token punctuation">;</span>

<span class="token keyword">class</span> <span class="token class-name">ComponentA</span> <span class="token punctuation">{</span>
  <span class="token keyword">static</span> schema <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">booleanValue</span><span class="token operator">:</span> Type<span class="token punctuation">.</span>boolean<span class="token punctuation">,</span>
    <span class="token literal-property property">integerValue</span><span class="token operator">:</span> <span class="token punctuation">{</span><span class="token literal-property property">type</span><span class="token operator">:</span> Type<span class="token punctuation">.</span>uint32<span class="token punctuation">,</span> <span class="token keyword">default</span><span class="token operator">:</span> <span class="token number">10</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token literal-property property">stringValue</span><span class="token operator">:</span> <span class="token punctuation">{</span><span class="token literal-property property">type</span><span class="token operator">:</span> Type<span class="token punctuation">.</span><span class="token function">dynamicString</span><span class="token punctuation">(</span><span class="token number">32</span><span class="token punctuation">)</span><span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><div class="language-ts"><pre><code><span class="token keyword">import</span> <span class="token punctuation">{</span>component<span class="token punctuation">,</span> field<span class="token punctuation">,</span> Type<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&#39;@lastolivegames/becsy&#39;</span><span class="token punctuation">;</span>

<span class="token decorator"><span class="token at operator">@</span><span class="token function">component</span></span> <span class="token keyword">class</span> <span class="token class-name">ComponentA</span> <span class="token punctuation">{</span>
  <span class="token decorator"><span class="token at operator">@</span><span class="token function">field</span></span><span class="token punctuation">.</span><span class="token builtin">boolean</span> <span class="token keyword">declare</span> booleanValue<span class="token operator">:</span> <span class="token builtin">boolean</span><span class="token punctuation">;</span>
  <span class="token decorator"><span class="token at operator">@</span><span class="token function">field</span></span><span class="token punctuation">(</span><span class="token punctuation">{</span>type<span class="token operator">:</span> Type<span class="token punctuation">.</span>uint32<span class="token punctuation">,</span> <span class="token keyword">default</span><span class="token operator">:</span> <span class="token number">10</span><span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token keyword">declare</span> integerValue<span class="token operator">:</span> <span class="token builtin">number</span><span class="token punctuation">;</span>
  <span class="token decorator"><span class="token at operator">@</span><span class="token function">field</span></span><span class="token punctuation">.</span><span class="token function">dynamicString</span><span class="token punctuation">(</span><span class="token number">32</span><span class="token punctuation">)</span> <span class="token keyword">declare</span> stringValue<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>Each field in the schema represents one property on the component&#39;s instances, and can also be used to set default values. Some component types are used just as tags and don&#39;t store any data, in which case your should omit the schema to enable some optimizations.</p><div class="danger custom-block"><p class="custom-block-title">WARNING</p><p>You must only set the fields declared in your schema on component instances. Any other properties will be dropped.</p></div><div class="tip custom-block"><p class="custom-block-title">TIP</p><p>For components with a single field it might be tempting to name it the same as the component, but this leads to awkward code when accessing it later, e.g., <code>entity.read(Acceleration).acceleration</code>. Instead, we recommend naming the sole field <code>value</code> so the code becomes <code>entity.read(Acceleration).value</code> instead.</p></div><div class="only-ts"><p>The schema declared in the component somewhat duplicates the TypeScript property types, but it&#39;s necessary as Becsy uses primitive-valued array buffers that don&#39;t map cleanly to JavaScript values. It&#39;s also important to use the <code>declare</code> keyword so that Becsy can take full control of the property definitions.</p><p>The <code>@component</code> decorator is optional; if included, it automatically adds the class to every world&#39;s <code>defs</code> list (as long as the module has been imported before the world is created, of course).</p></div><p>While you should generally keep behavior out of components \u2014 lest you fall into an object-oriented architecture instead \u2014 we think it&#39;s fine and useful to, for example, define generic getters and setters on your component classes to assist with data wrangling. This is especially the case if you&#39;re packing multiple values into a field using bit-level operations to lower your memory footprint.</p><div class="warning custom-block"><p class="custom-block-title">WARNING</p><p>To interact with components in any way (add, read, write, remove), your systems need to declare <a href="./queries.html#declaring-entitlements">access entitlements</a> in their queries.</p></div><h2 id="field-types" tabindex="-1">Field types <a class="header-anchor" href="#field-types" aria-hidden="true">#</a></h2><div class="only-js"><p>Becsy makes available the following field types as static members on the <code>Type</code> class. They&#39;re tightly integrated with the engine so it&#39;s not possible to add new ones in your app.</p></div><div class="only-ts"><p>Becsy makes available the following field types as static members on the <code>Type</code> class, as well as on the <code>@field</code> decorator. They&#39;re tightly integrated with the engine so it&#39;s not possible to add new ones in your app.</p></div><p>Unless otherwise stated, the types are strict and don&#39;t accept <code>null</code> or <code>undefined</code> as values.</p><table><thead><tr><th>Type <span style="float:right;font-weight:normal;">(default, JS type)</span></th></tr></thead><tbody><tr><td><strong><code>boolean</code></strong> <span style="float:right;">(<code>false</code>, <code>boolean</code>)</span> <br><span style="display:inline-block;margin-top:0.5em;">\u200B</span>A simple boolean type that accepts only <code>true</code> and <code>false</code> values. Each value occupies a full byte, though.</td></tr><tr><td><strong><code>int8</code>, <code>uint8</code>, <code>int16</code>, <code>uint16</code>, <code>int32</code>, <code>uint32</code></strong> <span style="float:right;font-weight:normal;">(<code>0</code>, <code>number</code>)</span> <br><span style="display:inline-block;margin-top:0.5em;">\u200B</span>Integer types of various bit sizes, both signed and unsigned (the latter with a <code>u</code> prefix).</td></tr><tr><td><strong><code>float32</code>, <code>float64</code></strong> <span style="float:right;font-weight:normal;">(<code>0</code>, <code>number</code>)</span> <br><span style="display:inline-block;margin-top:0.5em;">\u200B</span>Single and double precision floating point number types. <code>float64</code> is equivalent to JavaScript&#39;s <code>number</code> type.</td></tr><tr><td><strong><code>vector(type, elements, class?)</code></strong> <span style="float:right;font-weight:normal;">(<code>[0, 0, ...]</code>, <code>Array</code>)</span><br><span style="display:inline-block;margin-top:0.5em;">\u200B</span>Fixed-length array of one of the numeric types above; see <a href="#numeric-vectors">below</a> for details.</td></tr><tr><td><strong><code>dynamicString(maxUtf8Length: number)</code></strong> <span style="float:right;font-weight:normal;">(<code>&#39;&#39;</code>, <code>string</code>)</span> <br><span style="display:inline-block;margin-top:0.5em;">\u200B</span>A string type that accepts any string value as long as it doesn&#39;t exceed the given maximum length when encoded with UTF-8. Useful for unpredictable strings such as usernames.</td></tr><tr><td><strong><code>staticString(choices: string[])</code></strong> <span style="float:right;font-weight:normal;">(first choice, <code>string</code>)</span> <br><span style="display:inline-block;margin-top:0.5em;">\u200B</span>A string type that can only be set to values from a preselected array of strings. The value is stored as an integer index into the string array so it&#39;s very efficient, but you cannot add new string values at runtime. Useful for message strings built into your application.</td></tr><tr><td><strong><code>object</code></strong> <span style="float:right;font-weight:normal;">( <code>undefined</code>, any)</span> <br><span style="display:inline-block;margin-top:0.5em;">\u200B</span>A type that can accept any JavaScript object as value, including <code>undefined</code> and <code>null</code>. This should only be used for interfacing with other libraries as it can&#39;t be shared between threads and doesn&#39;t perform as well as the primitive types even on a single thread.</td></tr><tr><td><strong><code>weakObject</code></strong> <span style="float:right;font-weight:normal;">(<code>undefined</code>, any)</span> <br><span style="display:inline-block;margin-top:0.5em;">\u200B</span>A weak reference to a JavaScript object that won&#39;t prevent it from being garbage collected. It suffers from the same disadvantages as <code>object</code> above. Values default to <code>undefined</code>, and automatically become <code>undefined</code> when the object is garbage collected.</td></tr><tr><td><strong><code>ref</code></strong> <span style="float:right;font-weight:normal;">(<code>null</code>, <code>Entity</code>)</span> <br><span style="display:inline-block;margin-top:0.5em;">\u200B</span>A unidirectional reference to a single entity or <code>null</code>; see <a href="#referencing-entities">below</a> for details.</td></tr><tr><td><strong><code>backrefs(type?, fieldName?, trackDeletedBackrefs?)</code></strong> <span style="float:right;font-weight:normal;">(<code>[]</code>, <code>Entity[]</code>)</span> <br><span style="display:inline-block;margin-top:0.5em;">\u200B</span>An automatically populated list of references to the entity that contains a component with this field; see <a href="#referencing-entities">below</a> for details. Fields with this type cannot be set by your application.</td></tr></tbody></table><h2 id="numeric-vectors" tabindex="-1">Numeric vectors <a class="header-anchor" href="#numeric-vectors" aria-hidden="true">#</a></h2><p>When you need a component to hold some numeric values of the same type, you can of course declare them as separate fields. However, it often makes sense to treat them as a single, composite value, whether for better organization, for increased performance due to cache locality, or to fit in with a third party API. In that case you can declare a vector field instead:</p><div class="language-ts"><pre><code><span class="token decorator"><span class="token at operator">@</span><span class="token function">component</span></span> <span class="token keyword">class</span> <span class="token class-name">MovingEntity</span> <span class="token punctuation">{</span>
  <span class="token decorator"><span class="token at operator">@</span><span class="token function">field</span></span><span class="token punctuation">.</span>float64<span class="token punctuation">.</span><span class="token function">vector</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span> <span class="token keyword">declare</span> position<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token builtin">number</span><span class="token punctuation">,</span> <span class="token builtin">number</span><span class="token punctuation">,</span> <span class="token builtin">number</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token decorator"><span class="token at operator">@</span><span class="token function">field</span></span><span class="token punctuation">.</span>float64<span class="token punctuation">.</span><span class="token function">vector</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span> <span class="token keyword">declare</span> velocity<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token builtin">number</span><span class="token punctuation">,</span> <span class="token builtin">number</span><span class="token punctuation">,</span> <span class="token builtin">number</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

world<span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span>sys <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> player <span class="token operator">=</span> sys<span class="token punctuation">.</span><span class="token function">createEntity</span><span class="token punctuation">(</span>
    MovingEntity<span class="token punctuation">,</span> <span class="token punctuation">{</span>position<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">]</span><span class="token punctuation">,</span> velocity<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token number">1.5</span><span class="token punctuation">,</span> <span class="token number">0.2</span><span class="token punctuation">,</span> <span class="token number">0.1</span><span class="token punctuation">]</span><span class="token punctuation">}</span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> mover <span class="token operator">=</span> player<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span>MovingEntity<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> move<span class="token punctuation">.</span>position<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    move<span class="token punctuation">.</span>position<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">+=</span> mover<span class="token punctuation">.</span>velocity<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><div class="language-js"><pre><code><span class="token keyword">class</span> <span class="token class-name">MovingEntity</span> <span class="token punctuation">{</span>
  <span class="token keyword">static</span> schema <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">position</span><span class="token operator">:</span> Type<span class="token punctuation">.</span><span class="token function">vector</span><span class="token punctuation">(</span>Type<span class="token punctuation">.</span>float64<span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token literal-property property">velocity</span><span class="token operator">:</span> Type<span class="token punctuation">.</span><span class="token function">vector</span><span class="token punctuation">(</span>Type<span class="token punctuation">.</span>float64<span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

world<span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token parameter">sys</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> player <span class="token operator">=</span> sys<span class="token punctuation">.</span><span class="token function">createEntity</span><span class="token punctuation">(</span>
    MovingEntity<span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token literal-property property">position</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token literal-property property">velocity</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token number">1.5</span><span class="token punctuation">,</span> <span class="token number">0.2</span><span class="token punctuation">,</span> <span class="token number">0.1</span><span class="token punctuation">]</span><span class="token punctuation">}</span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> mover <span class="token operator">=</span> player<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span>MovingEntity<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> mover<span class="token punctuation">.</span>position<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    move<span class="token punctuation">.</span>position<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">+=</span> mover<span class="token punctuation">.</span>velocity<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>This declares two fields, each a vector of exactly three <code>float64</code> numbers. A vector&#39;s number elements will be stored together compactly by Becsy, and the vector will appear as an array-like object with a <code>length</code> property and indexed accessors for its properties. You can access the elements individually, and you can also assign an array of the correct length to the field, which will get its elements copied into the component.</p><div class="warning custom-block"><p class="custom-block-title">WARNING</p><p>While a vector appears array-like, it is not an actual JavaScript array: it has a fixed length, and lacks any of the usual <code>Array</code> methods.</p></div><p>For better readability, you can also name the vector&#39;s elements and access them that way:</p><div class="language-ts"><pre><code><span class="token decorator"><span class="token at operator">@</span><span class="token function">component</span></span> <span class="token keyword">class</span> <span class="token class-name">MovingEntity</span> <span class="token punctuation">{</span>
  <span class="token decorator"><span class="token at operator">@</span><span class="token function">field</span></span><span class="token punctuation">.</span>float64<span class="token punctuation">.</span><span class="token function">vector</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">&#39;x&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;y&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;z&#39;</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
  <span class="token keyword">declare</span> position<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token builtin">number</span><span class="token punctuation">,</span> <span class="token builtin">number</span><span class="token punctuation">,</span> <span class="token builtin">number</span><span class="token punctuation">]</span> <span class="token operator">&amp;</span> <span class="token punctuation">{</span>x<span class="token operator">:</span> <span class="token builtin">number</span><span class="token punctuation">,</span> y<span class="token operator">:</span> <span class="token builtin">number</span><span class="token punctuation">,</span> z<span class="token operator">:</span> <span class="token builtin">number</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token decorator"><span class="token at operator">@</span><span class="token function">field</span></span><span class="token punctuation">.</span>float64<span class="token punctuation">.</span><span class="token function">vector</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">&#39;x&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;y&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;z&#39;</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
  <span class="token keyword">declare</span> velocity<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token builtin">number</span><span class="token punctuation">,</span> <span class="token builtin">number</span><span class="token punctuation">,</span> <span class="token builtin">number</span><span class="token punctuation">]</span> <span class="token operator">&amp;</span> <span class="token punctuation">{</span>x<span class="token operator">:</span> <span class="token builtin">number</span><span class="token punctuation">,</span> y<span class="token operator">:</span> <span class="token builtin">number</span><span class="token punctuation">,</span> z<span class="token operator">:</span> <span class="token builtin">number</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

world<span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span>sys <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> player <span class="token operator">=</span> sys<span class="token punctuation">.</span><span class="token function">createEntity</span><span class="token punctuation">(</span>
    MovingEntity<span class="token punctuation">,</span> <span class="token punctuation">{</span>position<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">]</span><span class="token punctuation">,</span> velocity<span class="token operator">:</span> <span class="token punctuation">{</span>x<span class="token operator">:</span> <span class="token number">1.5</span><span class="token punctuation">,</span> y<span class="token operator">:</span> <span class="token number">0.2</span><span class="token punctuation">,</span> z<span class="token operator">:</span> <span class="token number">0.1</span><span class="token punctuation">}</span><span class="token punctuation">}</span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> mover <span class="token operator">=</span> player<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span>MovingEntity<span class="token punctuation">)</span><span class="token punctuation">;</span>
  mover<span class="token punctuation">.</span>position<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">+=</span> mover<span class="token punctuation">.</span>velocity<span class="token punctuation">.</span>x<span class="token punctuation">;</span>
  mover<span class="token punctuation">.</span>position<span class="token punctuation">.</span>x <span class="token operator">+=</span> mover<span class="token punctuation">.</span>velocity<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
  mover<span class="token punctuation">.</span>position<span class="token punctuation">.</span>z <span class="token operator">+=</span> mover<span class="token punctuation">.</span>velocity<span class="token punctuation">.</span>z<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><div class="language-js"><pre><code><span class="token keyword">class</span> <span class="token class-name">MovingEntity</span> <span class="token punctuation">{</span>
  <span class="token keyword">static</span> schema <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">position</span><span class="token operator">:</span> Type<span class="token punctuation">.</span><span class="token function">vector</span><span class="token punctuation">(</span>Type<span class="token punctuation">.</span>float64<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token string">&#39;x&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;y&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;z&#39;</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token literal-property property">velocity</span><span class="token operator">:</span> Type<span class="token punctuation">.</span><span class="token function">vector</span><span class="token punctuation">(</span>Type<span class="token punctuation">.</span>float64<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token string">&#39;x&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;y&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;z&#39;</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

world<span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token parameter">sys</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> player <span class="token operator">=</span> sys<span class="token punctuation">.</span><span class="token function">createEntity</span><span class="token punctuation">(</span>
    MovingEntity<span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token literal-property property">position</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token literal-property property">velocity</span><span class="token operator">:</span> <span class="token punctuation">{</span><span class="token literal-property property">x</span><span class="token operator">:</span> <span class="token number">1.5</span><span class="token punctuation">,</span> <span class="token literal-property property">y</span><span class="token operator">:</span> <span class="token number">0.2</span><span class="token punctuation">,</span> <span class="token literal-property property">z</span><span class="token operator">:</span> <span class="token number">0.1</span><span class="token punctuation">}</span><span class="token punctuation">}</span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> mover <span class="token operator">=</span> player<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span>MovingEntity<span class="token punctuation">)</span><span class="token punctuation">;</span>
  mover<span class="token punctuation">.</span>position<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">+=</span> mover<span class="token punctuation">.</span>velocity<span class="token punctuation">.</span>x<span class="token punctuation">;</span>
  mover<span class="token punctuation">.</span>position<span class="token punctuation">.</span>x <span class="token operator">+=</span> mover<span class="token punctuation">.</span>velocity<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
  mover<span class="token punctuation">.</span>position<span class="token punctuation">.</span>z <span class="token operator">+=</span> mover<span class="token punctuation">.</span>velocity<span class="token punctuation">.</span>z<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>You can then access the elements interchangeably either by index or by name, and assign either an array or an object to the field, whichever&#39;s more convenient.</p><p>Finally, you can specify a custom class to use for the array-like value. This can be useful if you&#39;re using a library that provides a vector-like abstract data type with useful methods that you&#39;d like to be able to use directly on your Becsy data. It differs from using <code>Type.object</code> because the data is still stored by Becsy in a multithreading-compatible fashion, and fungible instances of the custom class are used as a thin veneer on top. To achieve this, the vector&#39;s array-like and named element properties are used to override the class&#39;s ones, which works well for simple ADTs but can break the host class in more complex cases \u2014 you won&#39;t know until you try.</p><div class="tip custom-block"><p class="custom-block-title">TIP</p><p>For convenience, you might also want to declare the field type once for reuse throughout your components.</p></div><p>Here&#39;s a made-up example that incorporates all of the above:</p><div class="language-ts"><pre><code><span class="token keyword">class</span> <span class="token class-name">Vector3</span> <span class="token punctuation">{</span>
  x<span class="token operator">:</span> <span class="token builtin">number</span><span class="token punctuation">;</span>
  y<span class="token operator">:</span> <span class="token builtin">number</span><span class="token punctuation">;</span>
  z<span class="token operator">:</span> <span class="token builtin">number</span><span class="token punctuation">;</span>

  <span class="token function">add</span><span class="token punctuation">(</span>that<span class="token operator">:</span> Vector3<span class="token punctuation">)</span><span class="token operator">:</span> <span class="token keyword">void</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>x <span class="token operator">+=</span> that<span class="token punctuation">.</span>x<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>y <span class="token operator">+=</span> that<span class="token punctuation">.</span>y<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>z <span class="token operator">+=</span> that<span class="token punctuation">.</span>z<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">const</span> v3Type <span class="token operator">=</span> Type<span class="token punctuation">.</span><span class="token function">vector</span><span class="token punctuation">(</span>Type<span class="token punctuation">.</span>float64<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token string">&#39;x&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;y&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;z&#39;</span><span class="token punctuation">]</span><span class="token punctuation">,</span> Vector3<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token decorator"><span class="token at operator">@</span><span class="token function">component</span></span> <span class="token keyword">class</span> <span class="token class-name">MovingEntity</span> <span class="token punctuation">{</span>
  <span class="token decorator"><span class="token at operator">@</span><span class="token function">field</span></span><span class="token punctuation">(</span>v3Type<span class="token punctuation">)</span> <span class="token keyword">declare</span> position<span class="token operator">:</span> Vector3<span class="token punctuation">;</span>
  <span class="token decorator"><span class="token at operator">@</span><span class="token function">field</span></span><span class="token punctuation">(</span>v3Type<span class="token punctuation">)</span> <span class="token keyword">declare</span> velocity<span class="token operator">:</span> Vector3<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

world<span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span>sys <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> player <span class="token operator">=</span> sys<span class="token punctuation">.</span><span class="token function">createEntity</span><span class="token punctuation">(</span>
    MovingEntity<span class="token punctuation">,</span> <span class="token punctuation">{</span>position<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">]</span><span class="token punctuation">,</span> velocity<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token number">1.5</span><span class="token punctuation">,</span> <span class="token number">0.2</span><span class="token punctuation">,</span> <span class="token number">0.1</span><span class="token punctuation">]</span><span class="token punctuation">}</span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> mover <span class="token operator">=</span> player<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span>MovingEntity<span class="token punctuation">)</span><span class="token punctuation">;</span>
  mover<span class="token punctuation">.</span>position<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>mover<span class="token punctuation">.</span>velocity<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><div class="language-js"><pre><code><span class="token keyword">class</span> <span class="token class-name">Vector3</span> <span class="token punctuation">{</span>
  <span class="token literal-property property">x</span><span class="token operator">:</span> number<span class="token punctuation">;</span>
  <span class="token literal-property property">y</span><span class="token operator">:</span> number<span class="token punctuation">;</span>
  <span class="token literal-property property">z</span><span class="token operator">:</span> number<span class="token punctuation">;</span>

  <span class="token function">add</span><span class="token punctuation">(</span>that<span class="token operator">:</span> Vector3<span class="token punctuation">)</span><span class="token operator">:</span> <span class="token keyword">void</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>x <span class="token operator">+=</span> that<span class="token punctuation">.</span>x<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>y <span class="token operator">+=</span> that<span class="token punctuation">.</span>y<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>z <span class="token operator">+=</span> that<span class="token punctuation">.</span>z<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">const</span> v3Type <span class="token operator">=</span> Type<span class="token punctuation">.</span><span class="token function">vector</span><span class="token punctuation">(</span>Type<span class="token punctuation">.</span>float64<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token string">&#39;x&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;y&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;z&#39;</span><span class="token punctuation">]</span><span class="token punctuation">,</span> Vector3<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">class</span> <span class="token class-name">MovingEntity</span> <span class="token punctuation">{</span>
  <span class="token keyword">static</span> schema <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">position</span><span class="token operator">:</span> v3Type<span class="token punctuation">,</span>
    <span class="token literal-property property">velocity</span><span class="token operator">:</span> v3Type
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

world<span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token parameter">sys</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> player <span class="token operator">=</span> sys<span class="token punctuation">.</span><span class="token function">createEntity</span><span class="token punctuation">(</span>
    MovingEntity<span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token literal-property property">position</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token literal-property property">velocity</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token number">1.5</span><span class="token punctuation">,</span> <span class="token number">0.2</span><span class="token punctuation">,</span> <span class="token number">0.1</span><span class="token punctuation">]</span><span class="token punctuation">}</span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> mover <span class="token operator">=</span> player<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span>MovingEntity<span class="token punctuation">)</span><span class="token punctuation">;</span>
  mover<span class="token punctuation">.</span>position<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>mover<span class="token punctuation">.</span>velocity<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h2 id="referencing-entities" tabindex="-1">Referencing entities <a class="header-anchor" href="#referencing-entities" aria-hidden="true">#</a></h2><p>Applications often need to establish relationships between entities, and Becsy caters for this need directly with <code>Type.ref</code> and <code>Type.backrefs</code> properties.</p><div class="warning custom-block"><p class="custom-block-title">WARNING</p><p>You should never reference entities via their IDs or as <code>Entity</code> objects held in <code>Type.object</code> properties.</p></div><p>A <code>Type.ref</code> field holds a reference to any other single entity, or <code>null</code> to indicate that it&#39;s empty. It will automatically be nulled out if the target entity is deleted, though its previous value remains accessible via <code>System.accessRecentlyDeletedData</code> until the reference is overwritten or the deleted entity purged.</p><p>A <code>Type.backrefs</code> field automatically builds a list of references to the entity on which its component resides. Becsy automatically processes reference changes and entity deletions to keep the list current and it cannot be modified manually. The order of the entities in the list is arbitrary.</p><div class="info custom-block"><p class="custom-block-title">INFO</p><p>A system that modifies <code>ref</code> properties also needs <code>write</code> entitlements to all the component types with <code>backrefs</code> that might change automatically in response, as these are treated as implicit writes.</p></div><p>A <code>backrefs</code> field can be configured in a few different ways:</p><ul><li>By default, with no parameters, all references to the entity will be included. This is the cheapest option as Becsy needs to maintain such backrefs for itself anyway.</li><li>If you specify a component type then only references from components of that type will be included. This is the most expensive option as Becsy needs to allow for the possibility of multiple <code>ref</code> properties in a component pointing to the same entity.</li><li>If you specify both a component type and the name of a <code>ref</code> field name in that component then only references from that field will be included. This is more expensive than the default of all references but safer, as the <code>backrefs</code> won&#39;t pick up any other references that you might add later to your application. It&#39;s also cheaper than specifying just a component type.</li><li>Finally, by default you cannot read <code>backrefs</code> properties when operating under <code>System.accessRecentlyDeletedData</code> conditions. If you need to do that then pass an extra flag to the type constructor to track deleted backrefs, but be aware that this will effectively double the cost of the field.</li></ul><p>The <code>backrefs</code> field type lets you build 1-<em>N</em> relationships where the <em>N</em> is unbounded. For example, you could model an inventory this way:</p><div class="language-ts"><pre><code><span class="token decorator"><span class="token at operator">@</span><span class="token function">component</span></span> <span class="token keyword">class</span> <span class="token class-name">Packed</span> <span class="token punctuation">{</span>
  <span class="token decorator"><span class="token at operator">@</span><span class="token function">field</span></span><span class="token punctuation">.</span>ref <span class="token keyword">declare</span> holder<span class="token operator">:</span> Entity<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token decorator"><span class="token at operator">@</span><span class="token function">component</span></span> <span class="token keyword">class</span> <span class="token class-name">Inventory</span> <span class="token punctuation">{</span>
  <span class="token decorator"><span class="token at operator">@</span><span class="token function">field</span></span><span class="token punctuation">.</span><span class="token function">backrefs</span><span class="token punctuation">(</span>Packed<span class="token punctuation">,</span> <span class="token string">&#39;holder&#39;</span><span class="token punctuation">)</span> <span class="token keyword">declare</span> contents<span class="token operator">:</span> Entity<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

world<span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span>sys <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> player <span class="token operator">=</span> sys<span class="token punctuation">.</span><span class="token function">createEntity</span><span class="token punctuation">(</span>Inventory<span class="token punctuation">,</span> Health<span class="token punctuation">,</span> <span class="token comment">/* etc */</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> potion <span class="token operator">=</span> sys<span class="token punctuation">.</span><span class="token function">createEntity</span><span class="token punctuation">(</span>Potion<span class="token punctuation">,</span> <span class="token punctuation">{</span>healing<span class="token operator">:</span> <span class="token number">200</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> sword <span class="token operator">=</span> sys<span class="token punctuation">.</span><span class="token function">createEntity</span><span class="token punctuation">(</span>Sword<span class="token punctuation">,</span> <span class="token punctuation">{</span>damage<span class="token operator">:</span> <span class="token number">50</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// Put both items in the player&#39;s inventory</span>
  potion<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>Packed<span class="token punctuation">,</span> <span class="token punctuation">{</span>holder<span class="token operator">:</span> player<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  sword<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>Packed<span class="token punctuation">,</span> <span class="token punctuation">{</span>holder<span class="token operator">:</span> player<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  player<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span>Inventory<span class="token punctuation">)</span><span class="token punctuation">.</span>contents<span class="token punctuation">;</span>  <span class="token comment">// [potion, sword] in any order</span>

  <span class="token comment">// Remove the sword from the inventory</span>
  sword<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>Packed<span class="token punctuation">)</span><span class="token punctuation">;</span>
  player<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span>Inventory<span class="token punctuation">)</span><span class="token punctuation">.</span>contents<span class="token punctuation">;</span>  <span class="token comment">// [potion]</span>

  <span class="token comment">// Destroy the potion</span>
  potion<span class="token punctuation">.</span><span class="token function">delete</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  player<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span>Inventory<span class="token punctuation">)</span><span class="token punctuation">.</span>contents<span class="token punctuation">;</span>  <span class="token comment">// []</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><div class="language-js"><pre><code><span class="token keyword">class</span> <span class="token class-name">Packed</span> <span class="token punctuation">{</span>
  <span class="token keyword">static</span> schema <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">holder</span><span class="token operator">:</span> Type<span class="token punctuation">.</span>ref
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">class</span> <span class="token class-name">Inventory</span> <span class="token punctuation">{</span>
  <span class="token keyword">static</span> schema <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">contents</span><span class="token operator">:</span> Type<span class="token punctuation">.</span><span class="token function">backrefs</span><span class="token punctuation">(</span>Packed<span class="token punctuation">,</span> <span class="token string">&#39;holder&#39;</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

world<span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token parameter">sys</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> player <span class="token operator">=</span> sys<span class="token punctuation">.</span><span class="token function">createEntity</span><span class="token punctuation">(</span>Inventory<span class="token punctuation">,</span> Health<span class="token punctuation">,</span> <span class="token comment">/* etc */</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> potion <span class="token operator">=</span> sys<span class="token punctuation">.</span><span class="token function">createEntity</span><span class="token punctuation">(</span>Potion<span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token literal-property property">healing</span><span class="token operator">:</span> <span class="token number">200</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> sword <span class="token operator">=</span> sys<span class="token punctuation">.</span><span class="token function">createEntity</span><span class="token punctuation">(</span>Sword<span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token literal-property property">damage</span><span class="token operator">:</span> <span class="token number">50</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// Put both items in the player&#39;s inventory</span>
  potion<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>Packed<span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token literal-property property">holder</span><span class="token operator">:</span> player<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  sword<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>Packed<span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token literal-property property">holder</span><span class="token operator">:</span> player<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  player<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span>Inventory<span class="token punctuation">)</span><span class="token punctuation">.</span>contents<span class="token punctuation">;</span>  <span class="token comment">// [potion, sword] in any order</span>

  <span class="token comment">// Remove the sword from the inventory</span>
  sword<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>Packed<span class="token punctuation">)</span><span class="token punctuation">;</span>
  player<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span>Inventory<span class="token punctuation">)</span><span class="token punctuation">.</span>contents<span class="token punctuation">;</span>  <span class="token comment">// [potion]</span>

  <span class="token comment">// Destroy the potion</span>
  potion<span class="token punctuation">.</span><span class="token function">delete</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  player<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span>Inventory<span class="token punctuation">)</span><span class="token punctuation">.</span>contents<span class="token punctuation">;</span>  <span class="token comment">// []</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>To build an <em>N</em>-<em>N</em> relationship you&#39;ll need to reify the relationship itself as an entity to provide a level of indirection to the links. Here&#39;s an example of a symmetric relationship:</p><div class="language-ts"><pre><code><span class="token decorator"><span class="token at operator">@</span><span class="token function">component</span></span> <span class="token keyword">class</span> <span class="token class-name">Friendship</span> <span class="token punctuation">{</span>
  <span class="token decorator"><span class="token at operator">@</span><span class="token function">field</span></span><span class="token punctuation">.</span>ref <span class="token keyword">declare</span> a<span class="token operator">:</span> Entity<span class="token punctuation">;</span>
  <span class="token decorator"><span class="token at operator">@</span><span class="token function">field</span></span><span class="token punctuation">.</span>ref <span class="token keyword">declare</span> b<span class="token operator">:</span> Entity<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token decorator"><span class="token at operator">@</span><span class="token function">component</span></span> <span class="token keyword">class</span> <span class="token class-name">Person</span> <span class="token punctuation">{</span>
  <span class="token decorator"><span class="token at operator">@</span><span class="token function">field</span></span><span class="token punctuation">.</span><span class="token function">backrefs</span><span class="token punctuation">(</span>Friendship<span class="token punctuation">)</span> <span class="token keyword">declare</span> friendships<span class="token operator">:</span> Entity<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

world<span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span>sys <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> p1 <span class="token operator">=</span> sys<span class="token punctuation">.</span><span class="token function">createEntity</span><span class="token punctuation">(</span>Person<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> p2 <span class="token operator">=</span> sys<span class="token punctuation">.</span><span class="token function">createEntity</span><span class="token punctuation">(</span>Person<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> p3 <span class="token operator">=</span> sys<span class="token punctuation">.</span><span class="token function">createEntity</span><span class="token punctuation">(</span>Person<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// Set up some friendships</span>
  <span class="token keyword">const</span> f1 <span class="token operator">=</span> sys<span class="token punctuation">.</span><span class="token function">createEntity</span><span class="token punctuation">(</span>Friendship<span class="token punctuation">,</span> <span class="token punctuation">{</span>a<span class="token operator">:</span> p1<span class="token punctuation">,</span> b<span class="token operator">:</span> p2<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> f2 <span class="token operator">=</span> sys<span class="token punctuation">.</span><span class="token function">createEntity</span><span class="token punctuation">(</span>Friendship<span class="token punctuation">,</span> <span class="token punctuation">{</span>a<span class="token operator">:</span> p1<span class="token punctuation">,</span> b<span class="token operator">:</span> p3<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  p1<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span>Person<span class="token punctuation">)</span><span class="token punctuation">.</span>friendships<span class="token punctuation">;</span>  <span class="token comment">// [f1, f2] in any order</span>
  p1<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span>Person<span class="token punctuation">)</span><span class="token punctuation">.</span>friendships<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>f <span class="token operator">=&gt;</span> f<span class="token punctuation">.</span>a <span class="token operator">===</span> p1 <span class="token operator">?</span> f<span class="token punctuation">.</span>b <span class="token operator">:</span> f<span class="token punctuation">.</span>a<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// [p2, p3] in any order</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><div class="language-js"><pre><code><span class="token keyword">class</span> <span class="token class-name">Friendship</span> <span class="token punctuation">{</span>
  <span class="token keyword">static</span> schema <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">a</span><span class="token operator">:</span> Type<span class="token punctuation">.</span>ref<span class="token punctuation">,</span>
    <span class="token literal-property property">b</span><span class="token operator">:</span> Type<span class="token punctuation">.</span>ref
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">class</span> <span class="token class-name">Person</span> <span class="token punctuation">{</span>
  <span class="token keyword">static</span> schema <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">friendships</span><span class="token operator">:</span> Type<span class="token punctuation">.</span><span class="token function">backrefs</span><span class="token punctuation">(</span>Friendship<span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>


world<span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token parameter">sys</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> p1 <span class="token operator">=</span> sys<span class="token punctuation">.</span><span class="token function">createEntity</span><span class="token punctuation">(</span>Person<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> p2 <span class="token operator">=</span> sys<span class="token punctuation">.</span><span class="token function">createEntity</span><span class="token punctuation">(</span>Person<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> p3 <span class="token operator">=</span> sys<span class="token punctuation">.</span><span class="token function">createEntity</span><span class="token punctuation">(</span>Person<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// Set up some friendships</span>
  <span class="token keyword">const</span> f1 <span class="token operator">=</span> sys<span class="token punctuation">.</span><span class="token function">createEntity</span><span class="token punctuation">(</span>Friendship<span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token literal-property property">a</span><span class="token operator">:</span> p1<span class="token punctuation">,</span> <span class="token literal-property property">b</span><span class="token operator">:</span> p2<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> f2 <span class="token operator">=</span> sys<span class="token punctuation">.</span><span class="token function">createEntity</span><span class="token punctuation">(</span>Friendship<span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token literal-property property">a</span><span class="token operator">:</span> p1<span class="token punctuation">,</span> <span class="token literal-property property">b</span><span class="token operator">:</span> p3<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  p1<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span>Person<span class="token punctuation">)</span><span class="token punctuation">.</span>friendships<span class="token punctuation">;</span>  <span class="token comment">// [f1, f2] in any order</span>
  p1<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span>Person<span class="token punctuation">)</span><span class="token punctuation">.</span>friendships<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token parameter">f</span> <span class="token operator">=&gt;</span> f<span class="token punctuation">.</span>a <span class="token operator">===</span> p1 <span class="token operator">?</span> f<span class="token punctuation">.</span>b <span class="token operator">:</span> f<span class="token punctuation">.</span>a<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// [p2, p3] in any order</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><h2 id="validating-component-combos" tabindex="-1">Validating component combos <a class="header-anchor" href="#validating-component-combos" aria-hidden="true">#</a></h2><p>In the ECS paradigm every entity can have one component of each type. However, not all component combinations will make sense in your application, and some might have deleterious effects on the systems processing them. While in principle you could &quot;just be careful&quot; to not put together incompatible components that can be hard to do in practice as your application grows.</p><p>You can enlist Becsy&#39;s help in checking for invalid component combinations by defining a static <code>validate</code> method on any component type. <em>All</em> such validation methods will be called on <em>all</em> entities that had component added or removed by a system, after that system has finished executing. (So even though a validation method is defined on a specific component type for convenience, it can actually validate any components on all entities.)</p><div class="info custom-block"><p class="custom-block-title">INFO</p><p>Component validation is disabled in the <a href="./../deploying.html">performance build</a>.</p></div><p>Here&#39;s an example where we want to forbid combining component types <code>B</code> and <code>C</code> together if an entity also has a component of type <code>A</code>:</p><div class="language-ts"><pre><code><span class="token decorator"><span class="token at operator">@</span><span class="token function">component</span></span> <span class="token keyword">class</span> <span class="token class-name"><span class="token constant">A</span></span> <span class="token punctuation">{</span>
  <span class="token keyword">static</span> <span class="token function">validate</span><span class="token punctuation">(</span>entity<span class="token operator">:</span> Entity<span class="token punctuation">)</span><span class="token operator">:</span> <span class="token keyword">void</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>entity<span class="token punctuation">.</span><span class="token function">has</span><span class="token punctuation">(</span><span class="token constant">A</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> entity<span class="token punctuation">.</span><span class="token function">hasAllOf</span><span class="token punctuation">(</span><span class="token constant">B</span><span class="token punctuation">,</span> <span class="token constant">C</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">&#39;cannot combine both B and C with A&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token decorator"><span class="token at operator">@</span><span class="token function">component</span></span> <span class="token keyword">class</span> <span class="token class-name"><span class="token constant">B</span></span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token decorator"><span class="token at operator">@</span><span class="token function">component</span></span> <span class="token keyword">class</span> <span class="token class-name"><span class="token constant">C</span></span> <span class="token punctuation">{</span><span class="token punctuation">}</span>

world<span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span>sys <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> entity <span class="token operator">=</span> sys<span class="token punctuation">.</span><span class="token function">createEntity</span><span class="token punctuation">(</span><span class="token constant">A</span><span class="token punctuation">,</span> <span class="token constant">B</span><span class="token punctuation">,</span> <span class="token constant">C</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// not an error yet -- we could still fix things by removing A, B or C</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// but once the system finishes an error is thrown</span>
</code></pre></div><div class="language-js"><pre><code><span class="token keyword">class</span> <span class="token class-name">A</span> <span class="token punctuation">{</span>
  <span class="token keyword">static</span> <span class="token function">validate</span><span class="token punctuation">(</span>entity<span class="token operator">:</span> Entity<span class="token punctuation">)</span><span class="token operator">:</span> <span class="token keyword">void</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>entity<span class="token punctuation">.</span><span class="token function">has</span><span class="token punctuation">(</span><span class="token constant">A</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> entity<span class="token punctuation">.</span><span class="token function">hasAllOf</span><span class="token punctuation">(</span><span class="token constant">B</span><span class="token punctuation">,</span> <span class="token constant">C</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">&#39;cannot combine both B and C with A&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">class</span> <span class="token class-name">B</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token keyword">class</span> <span class="token class-name">C</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>

world<span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token parameter">sys</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> entity <span class="token operator">=</span> sys<span class="token punctuation">.</span><span class="token function">createEntity</span><span class="token punctuation">(</span><span class="token constant">A</span><span class="token punctuation">,</span> <span class="token constant">B</span><span class="token punctuation">,</span> <span class="token constant">C</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// not an error yet -- we could still fix things by removing A, B or C</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// but once the system finishes an error is thrown</span>
</code></pre></div><p>A validation method can only check for the presence of components using the &quot;<code>has</code>&quot; family of methods on <code>Entity</code>. It cannot <code>read</code> the entity to access the field values, so your component constraints cannot depend on data values. Validators are also exempt from the system&#39;s access entitlements \u2014 they can check for the presence or absence of every type of component.</p><h2 id="component-enums" tabindex="-1">Component enums <a class="header-anchor" href="#component-enums" aria-hidden="true">#</a></h2><p>A very common restriction on component combinations is to allow at most one from a list of types to be present on an entity. This is similar to &quot;enums&quot; in many programming languages and is often used to implement state machines. Becsy supports this pattern directly and throws in a few extra features to boot.</p><p>You can define an enum and populate it with component types like so:</p><div class="language-js"><div class="highlight-lines"><br><br><br><div class="highlighted">\xA0</div><div class="highlighted">\xA0</div><br></div><pre><code><span class="token keyword">class</span> <span class="token class-name">A</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token keyword">class</span> <span class="token class-name">B</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token keyword">class</span> <span class="token class-name">C</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token comment">// Define an enum of component types A, B, and C.</span>
<span class="token keyword">const</span> myEnum <span class="token operator">=</span> World<span class="token punctuation">.</span><span class="token function">defineEnum</span><span class="token punctuation">(</span><span class="token string">&#39;myEnum&#39;</span><span class="token punctuation">,</span> <span class="token constant">A</span><span class="token punctuation">,</span> <span class="token constant">B</span><span class="token punctuation">,</span> <span class="token constant">C</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><div class="language-ts"><pre><code><span class="token keyword">const</span> myEnum <span class="token operator">=</span> World<span class="token punctuation">.</span><span class="token function">defineEnum</span><span class="token punctuation">(</span><span class="token string">&#39;myEnum&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token decorator"><span class="token at operator">@</span><span class="token function">component</span></span><span class="token punctuation">(</span>myEnum<span class="token punctuation">)</span> <span class="token keyword">class</span> <span class="token class-name"><span class="token constant">A</span></span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token decorator"><span class="token at operator">@</span><span class="token function">component</span></span><span class="token punctuation">(</span>myEnum<span class="token punctuation">)</span> <span class="token keyword">class</span> <span class="token class-name"><span class="token constant">B</span></span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token decorator"><span class="token at operator">@</span><span class="token function">component</span></span><span class="token punctuation">(</span>myEnum<span class="token punctuation">)</span> <span class="token keyword">class</span> <span class="token class-name"><span class="token constant">C</span></span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
</code></pre></div><div class="only-ts"><p>(You can also list the component types directly as part of the enum&#39;s definition instead.)</p></div><p>Any component types can be members of an enum, including ones with data fields. The enum name parameter is optional but will make any error message more useful. Passing the enum or any one of its members into the world&#39;s <code>defs</code> will automatically pull in all the rest.</p><div class="warning custom-block"><p class="custom-block-title">WARNING</p><p>A component type can be a member of at most one enum.</p></div><p>In general, enum components are used just like normal ones, and the enum itself can be used to represent the list of its members in any API that deals with components. The following chapters will also call out enum-specific features in each area.</p><h2 id="storage-strategies" tabindex="-1">Storage strategies <a class="header-anchor" href="#storage-strategies" aria-hidden="true">#</a></h2><p>Behind the scenes, rather than putting field values in properties of individual objects, Becsy stores them in contiguous, homogeneous buffers. All the values for field <code>foo</code> of all components of type <code>A</code> are stored in one buffer, all the values for field <code>bar</code> in another, and so on. There are different strategies for allocating and indexing these buffers that offer trade-offs between memory usage and performance. (Note, though, that except for the <code>compact</code> storage strategy, performance differences only show up in the <a href="./../deploying.html">performance build</a>).</p><p>You can select a storage strategy per component type by filling in a static <code>options</code> object in the class. For example:</p><div class="language-ts"><pre><code><span class="token decorator"><span class="token at operator">@</span><span class="token function">component</span></span> <span class="token keyword">class</span> <span class="token class-name"><span class="token constant">A</span></span> <span class="token punctuation">{</span>
  <span class="token keyword">static</span> options <span class="token operator">=</span> <span class="token punctuation">{</span>
    storage<span class="token operator">:</span> <span class="token string">&#39;packed&#39;</span><span class="token punctuation">,</span>
    capacity<span class="token operator">:</span> <span class="token number">1000</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><div class="language-js"><pre><code><span class="token keyword">class</span> <span class="token class-name">A</span> <span class="token punctuation">{</span>
  <span class="token keyword">static</span> options <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">storage</span><span class="token operator">:</span> <span class="token string">&#39;packed&#39;</span><span class="token punctuation">,</span>
    <span class="token literal-property property">capacity</span><span class="token operator">:</span> <span class="token number">1000</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>You can also set a default storage strategy for components that don&#39;t specify one by passing <code>defaultComponentStorage</code> to the <code>World.create</code> options. The default default is <code>packed</code> (elastic).</p><p>The available strategies are as follows, in order from fastest and most memory hungry to slowest and smallest.</p><ul><li><p><strong><code>sparse</code></strong>: This strategy allocates storage for every possible entity up front, indexed directly by entity ID. This is very fast as there&#39;s no indirect indexing step but can be extremely wasteful unless all or nearly all entities have a component of the given type. (You cannot specify a <code>capacity</code> or an <code>initialCapacity</code> for this strategy.)</p></li><li><p><strong><code>packed</code></strong>: This strategy allocates storage for a full index lookup table (up to 4 bytes for every possible entity), but uses smaller buffers for the actual field values. If you know the maximum number of components of a given type you can set the value buffers to a fixed size using the <code>capacity</code> option. If you don&#39;t know, the strategy defaults to an elastic variant that will grow the buffers as needed (though never shrink them). You can set the <code>initialCapacity</code> of these elastic buffers, but note that they&#39;re slower than the fixed size ones even if they never actually get resized.</p></li><li><p><strong><code>compact</code></strong>: This strategy uses both a small index lookup table and smaller value buffers, but accessing a value requires a <em>linear</em> scan of the index so it&#39;s only recommended if you have no more than a handful of components of a given type. Like the <code>packed</code> strategy there are both fixed size and elastic variants. This strategy is automatically applied to any component types used as <a href="./systems.html#singletons">singletons</a>.</p></li></ul><div class="tip custom-block"><p class="custom-block-title">TIP</p><p>When setting the storage <code>capacity</code> of a component type, remember to factor in that deleted entities <a href="./entities.html#deleting">hang around for up to 2 frames</a> before they are purged.</p></div>`,71);function i(u,r,k,d,y,m){const n=o("language-switcher");return e(),a("div",null,[t(n),l])}var b=s(c,[["render",i]]);export{h as __pageData,b as default};
